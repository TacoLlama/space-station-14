using Content.Shared.Preferences;
using Content.Shared._CD.Records;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using Robust.Client.UserInterface;
using Robust.Shared.IoC;
using Robust.Shared.Prototypes;

namespace Content.Client._CD.Records.UI;

/// <summary>
/// The record editor tab that gets "injected" into the character editor.
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class RecordEditorGui : Control
{
    [Dependency] private readonly IPrototypeManager _prototype = default!; // Starlight

    /// <summary>
    /// Delegate that tells the editor to save records when the save button is pressed
    /// </summary>
    private readonly Action<PlayerProvidedCharacterRecords> _updateProfileRecords;
    private PlayerProvidedCharacterRecords _records = default!;
    private HumanoidCharacterProfile? _profile;

    public RecordEditorGui(Action<PlayerProvidedCharacterRecords> updateProfileRecords)
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);
        _updateProfileRecords = updateProfileRecords;

        #region General

        ContactNameEdit.OnTextChanged += args =>
        {
            UpdateRecords(_records.WithContactName(args.Text));
        };

        #endregion

        #region Employment

        WorkAuthCheckBox.OnToggled += args =>
        {
            UpdateRecords(_records.WithWorkAuth(args.Pressed));
        };

        #endregion

        #region Security

        IdentifyingFeaturesEdit.OnTextChanged += args =>
        {
            UpdateRecords(_records.WithIdentifyingFeatures(args.Text));
        };

        #endregion

        #region Medical

        AllergiesEdit.OnTextChanged += args =>
        {
            UpdateRecords(_records.WithAllergies(args.Text));
        };

        DrugAllergiesEdit.OnTextChanged += args =>
        {
            UpdateRecords(_records.WithDrugAllergies(args.Text));
        };

        PostmortemEdit.OnTextChanged += args =>
        {
            UpdateRecords(_records.WithPostmortemInstructions(args.Text));
        };

        #endregion

        #region Entries

        EntryEditorTabs.SetTabTitle(0, Loc.GetString("humanoid-profile-editor-cd-records-employment"));
        EntryEditorTabs.SetTabTitle(1, Loc.GetString("department-Medical"));
        EntryEditorTabs.SetTabTitle(2, Loc.GetString("department-Security"));
        EntryEditorTabs.SetTabTitle(3, Loc.GetString("humanoid-profile-editor-cd-records-admin"));

        EmploymentEntrySelector.OnUpdateEntries += args =>
        {
            UpdateRecords(_records.WithEmploymentEntries(args.Entries));
        };

        MedicalEntrySelector.OnUpdateEntries += args =>
        {
            UpdateRecords(_records.WithMedicalEntries(args.Entries));
        };

        SecurityEntrySelector.OnUpdateEntries += args =>
        {
            UpdateRecords(_records.WithSecurityEntries(args.Entries));
        };

        AdminEntrySelector.OnUpdateEntries += args =>
        {
            UpdateRecords(_records.WithAdminEntries(args.Entries));
        };

        #endregion
    }

    public void Update(HumanoidCharacterProfile? profile)
    {
        _profile = profile;
        //this line is evil. basically.
        // check if we have set records. if we do use those
        // check if we have a HumanoidCharacter profile. if we do get it's species and use that
        // and if we dont just spitball a random guess.
        _records = profile?.CDCharacterRecords ?? (_profile != null ? PlayerProvidedCharacterRecords.DefaultRecords(_prototype.Index(_profile.Species)) : PlayerProvidedCharacterRecords.DefaultRecords());

        // Sync calculated height/weight immediately so the tab mirrors the sizing sliders.
        var metricsPersisted = TryPersistComputedMetrics();

        EmploymentEntrySelector.UpdateContents(_records.EmploymentEntries);
        MedicalEntrySelector.UpdateContents(_records.MedicalEntries);
        SecurityEntrySelector.UpdateContents(_records.SecurityEntries);
        AdminEntrySelector.UpdateContents(_records.AdminEntries);

        if (!metricsPersisted)
            UpdateWidgets();
    }

    public void UpdateComputedMetrics(HumanoidCharacterProfile? profile)
    {
        _profile = profile;
        if (!TryPersistComputedMetrics())
            UpdateWidgets();
    }

    private bool TryPersistComputedMetrics()
    {
        if (_profile == null)
            return false;

        var currentHeight = _records.Height;
        var currentWeight = _records.Weight;
        var updated = CharacterRecordSizeHelper.WithCalculatedMetrics(_records, _profile, _prototype);

        if (updated.Height == currentHeight && updated.Weight == currentWeight)
        {
            // Nothing changed; keep existing instance so we do not churn allocations.
            _records = updated;
            return false;
        }

        // Push newly derived metrics back to the character profile.
        UpdateRecords(updated);
        return true;
    }

    private void UpdateRecords(PlayerProvidedCharacterRecords records)
    {
        records.EnsureValid();
        _records = records;
        _updateProfileRecords(_records);
        UpdateWidgets();
    }

    private void UpdateWidgets()
    {
        HeightEdit.SetText(_records.Height.ToString());
        UpdateImperialHeight(_records.Height);
        WeightEdit.SetText(_records.Weight.ToString());
        UpdateImperialWeight(_records.Weight);
        ContactNameEdit.SetText(_records.EmergencyContactName);

        WorkAuthCheckBox.Pressed = _records.HasWorkAuthorization;

        IdentifyingFeaturesEdit.SetText(_records.IdentifyingFeatures);

        AllergiesEdit.SetText(_records.Allergies);
        DrugAllergiesEdit.SetText(_records.DrugAllergies);
        PostmortemEdit.SetText(_records.PostmortemInstructions);
    }

    private void UpdateImperialHeight(int newHeight)
    {
        HeightImperialLabel.Text = UnitConversion.GetImperialDisplayLength(newHeight);
    }

    private void UpdateImperialWeight(int newWeight)
    {
        WeightImperialLabel.Text = UnitConversion.GetImperialDisplayMass(newWeight);
    }
}

