using Content.Client.UserInterface.Controls;
using Content.Client.UserInterface.Fragments;
using Content.Shared.Mech.Components;
using Content.Shared.Mech.Equipment.Components;
using Content.Shared.Mech;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.Mech.Ui;

[GenerateTypedNameReferences]
public sealed partial class MechMenu : FancyWindow
{
    [Dependency] private readonly IEntityManager _ent = default!;

    private EntityUid _mech;

    public event Action<EntityUid>? OnRemoveButtonPressed;

    public event Action<bool>? OnMaintenanceModeChanged;

    public MechMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
    }

    public void SetEntity(EntityUid uid)
    {
        MechView.SetEntity(uid);
        _mech = uid;
    }

    public void UpdateMechStats(int EquipmentCount) // Starlight-edit: Correct equipment update
    {
        if (!_ent.TryGetComponent<MechComponent>(_mech, out var mechComp))
            return;

        var integrityPercent = mechComp.Integrity / mechComp.MaxIntegrity;
        IntegrityDisplayBar.Value = integrityPercent.Float();
        IntegrityDisplay.Text = Loc.GetString("mech-integrity-display", ("amount", (integrityPercent * 100).Int()));

        if (mechComp.MaxEnergy != 0f)
        {
            var energyPercent = mechComp.Energy / mechComp.MaxEnergy;
            EnergyDisplayBar.Value = energyPercent.Float();
            EnergyDisplay.Text = Loc.GetString("mech-energy-display", ("amount", (energyPercent * 100).Int()));
        }
        else
        {
            EnergyDisplayBar.Value = 0f;
            EnergyDisplay.Text = Loc.GetString("mech-energy-missing");
        }

        ActiveSlotDisplay.Text = Loc.GetString("mech-slot-display",
            ("amount", mechComp.MaxEquipmentAmount - EquipmentCount)); // Starlight-edit: Correct equipment update
    }

    public void UpdateEquipmentView(List<NetEntity> Equipment) // Starlight-edit: Correct equipment update
    {
        ActiveEquipmentContainer.Children.Clear();
        PassiveEquipmentContainer.Children.Clear();
        foreach (var netEntity in Equipment) // Starlight-edit: Correct equipment update
        {
            var ent = _ent.GetEntity(netEntity); // Starlight-edit: Correct equipment update

            if (!_ent.TryGetComponent<MetaDataComponent>(ent, out var metaData))
                continue;

            var uicomp = _ent.GetComponentOrNull<UIFragmentComponent>(ent);
            var ui = uicomp?.Ui?.GetUIFragmentRoot();

            var control = new MechEquipmentControl(ent, metaData.EntityName, ui);

            control.OnRemoveButtonPressed += () => OnRemoveButtonPressed?.Invoke(ent);

            if (_ent.TryGetComponent<MechEquipmentComponent>(ent, out var equipmentComp))
            {
                if (equipmentComp.EquipmentType == EquipmentType.Active)
                    ActiveEquipmentContainer.AddChild(control);
                else if (equipmentComp.EquipmentType == EquipmentType.Passive)
                    PassiveEquipmentContainer.AddChild(control);
            }
        }
    }

    public void UpdateMaintenanceButtons()
    {
        if (!_ent.TryGetComponent<MechComponent>(_mech, out var mechComp))
            return;

        MaintenanceOffButton.Disabled = !mechComp.MaintenanceMode;
        MaintenanceOffButton.OnPressed += _ =>
        {
            MaintenanceOffButton.Disabled = true;
            MaintenanceOnButton.Disabled = false;
            OnMaintenanceModeChanged?.Invoke(false);
        };
        MaintenanceOnButton.Disabled = mechComp.MaintenanceMode;
        MaintenanceOnButton.OnPressed += _ =>
        {
            MaintenanceOffButton.Disabled = false;
            MaintenanceOnButton.Disabled = true;
            OnMaintenanceModeChanged?.Invoke(true);
        };
    }
}

